---
title: "论文1酸感5.0"
author: "LX"
format: html
editor: visual
---

## \## 〇、项目概述与环境配置

\*\*核心策略：\*\* [1.]{.underline} \*\*数据源\*\*：仅使用 N=57 发现集，保证分析的一致性和统计效力。 [2.]{.underline} \*\*筛选逻辑\*\*：结合“统计显著性（Spearman/Kruskal-Wallis）”与“专家经验（16个核心指标）”。 [3.]{.underline} \*\*验证方式\*\*：通过聚类热图（Clustering Heatmap）验证核心指标是否能还原感官分类。

```{r}
#| label: setup
#| message: false
#| warning: false

# 1. 加载核心程序包
library(readr)      # 读取数据
library(dplyr)      # 数据清洗
library(tibble)     # 数据结构
library(tidyr)      # 数据整理
library(ggplot2)    # 绘图核心
library(ggpubr)     # 统计绘图扩展
library(pheatmap)   # 聚类热图
library(stringr)    # 字符串处理
library(showtext)   # 中文支持

# 2. 中文环境配置 (解决绘图乱码)
showtext_auto()
# 如果是 Windows，通常使用 SimHei 或 SimSun；Mac 使用 PingFang SC
# font_add("SimSun", "simsun.ttc") # 根据需要取消注释

# 3. 设置全局绘图主题
theme_set(theme_bw() + 
            theme(panel.grid = element_blank(),
                  plot.title = element_text(hjust = 0.5, face = "bold"),
                  axis.text = element_text(color = "black")))
```

## 一、数据加载与清洗 (Phase 1)

此处采用“映射表”机制，完美解决 R 语言对中文列名和特殊符号（如 `1-`, `()`）的不兼容问题。

```{r}
#| label: load-data
#| message: false

# 1. 读取数据
# 请确保 'data-57.csv' 在当前文件夹下
if (!file.exists("data-57.csv")) stop("错误：找不到 data-57.csv 文件！")
raw_data <- read_csv("data-57.csv", show_col_types = FALSE)

# 2. 构建“中文名 - 计算名”映射表
original_names <- colnames(raw_data)
clean_names <- make.names(original_names, unique = TRUE)

name_mapping <- tibble(
  Display_Name = original_names,      # 原名 (画图用)
  Computational_Name = clean_names    # 计算名 (统计用)
)

# 应用新列名
analysis_data <- raw_data
colnames(analysis_data) <- clean_names

# 3. 识别关键列与分组
# 假设: 第1列是样品ID，第2列是酸感得分
id_col <- clean_names[1]
score_col <- clean_names[2]

analysis_data <- analysis_data %>%
  rename(Sample_ID = all_of(id_col),
         Sourness_Score = all_of(score_col)) %>%
  # 按照 v5.0 的标准进行 4 级分组
  mutate(Group = cut(Sourness_Score, 
                     breaks = c(-Inf, 1.5, 3.0, 4.5, Inf),
                     labels = c("微酸 (Trace)", "稍酸 (Mild)", 
                                "酸 (Moderate)", "很酸 (Strong)"),
                     include.lowest = TRUE))

# 4. 提取候选化学物质列表 (排除 ID, Score, Group)
candidates <- name_mapping %>%
  filter(!Computational_Name %in% c(id_col, score_col, "Group"))

cat(">>> 数据准备就绪：\n")
cat("    样品数量:", nrow(analysis_data), "\n")
cat("    化学指标:", nrow(candidates), "个\n")
```

## 二、正态性和鲁棒性检验

```{r}
# ==========================================================
#  数据体检自测脚本 (No Black Box)
# ==========================================================
library(readr)
library(dplyr)
library(tidyr)
library(rstatix) # 用于正态性检验

# 1. 读取数据
df <- read_csv("data-57.csv") 
num_cols <- df %>% select(where(is.numeric)) %>% colnames()


# ----------------------------------------------------------
# A. 正态性检验 (Shapiro-Wilk 方法)
# 原理：P > 0.05 代表正态；P < 0.05 代表不正态
# ----------------------------------------------------------
normality_report <- data.frame(Variable = num_cols, P_value = NA, Is_Normal = NA)

for (i in 1:length(num_cols)) {
  col <- num_cols[i]
  vals <- df[[col]]
  
  # Shapiro检验要求样本量 3-5000
  if (length(na.omit(vals)) >= 3) {
    res <- shapiro_test(vals)
    normality_report$P_value[i] <- res$p.value
    normality_report$Is_Normal[i] <- ifelse(res$p.value > 0.05, "Yes", "No")
  }
}

# 保存正态性报告
View(normality_report)



# ----------------------------------------------------------
# B. 鲁棒离群值检测 (IQR / Boxplot Method)
# 原理：不看平均值，看中位数。
# 标准：超过 (Q3 + 3*IQR) 或 低于 (Q1 - 3*IQR) 为极端异常
# ----------------------------------------------------------
robust_report <- data.frame()

for (col in num_cols) {
  vals <- df[[col]]
  
  # 计算四分位数 (25% 和 75%)
  Q1 <- quantile(vals, 0.25, na.rm = TRUE)
  Q3 <- quantile(vals, 0.75, na.rm = TRUE)
  IQR_val <- Q3 - Q1
  median_val <- median(vals, na.rm = TRUE)
  
  # 定义极端异常的界限 (Extreme Outlier Limits)
  # 这里的 3 倍 IQR 相当于抓 "极度离谱" 的值
  # 如果想抓得严一点，可以把 3 改成 1.5
  upper_limit <- Q3 + 3 * IQR_val
  lower_limit <- Q1 - 3 * IQR_val
  
  # 找到异常值的位置
  bad_idx <- which(vals > upper_limit | vals < lower_limit)
  
  if (length(bad_idx) > 0) {
    temp <- data.frame(
      Variable = col,
      SampleID = df$'样品编号'[bad_idx],
      Value = vals[bad_idx],
      Median = median_val,
      # 计算偏离程度 (倍数)：(值 - 中位数) / IQR
      # 这个值越大，说明越离谱
      Deviation_Score = round((vals[bad_idx] - median_val) / IQR_val, 2)
    )
    # 过滤掉 Deviation_Score 无穷大或太小的情况
    temp <- temp %>% filter(is.finite(Deviation_Score) & abs(Deviation_Score) > 0)
    
    robust_report <- rbind(robust_report, temp)
  }
}

# 按离谱程度排序 (从大到小)
robust_report <- robust_report %>% arrange(desc(Deviation_Score))

# 查看
View(robust_report)
```

## 三、描述性统计

## 3.1酸感描述性统计

```{r}
# ==========================================================
# Phase 2: 描述性统计 (Descriptive Statistics) - 中英文混合旗舰版
# ==========================================================

# 1. 确保数据已加载
if (!exists("analysis_data")) stop("请先运行 Phase 1 加载数据！")

# 加载计算偏度峰度的包 (如果没有会自动使用替补函数)
if (!requireNamespace("e1071", quietly = TRUE)) {
  skewness <- function(x) { n <- length(x); (sum((x-mean(x))^3)/n)/(sum((x-mean(x))^2)/n)^1.5 }
  kurtosis <- function(x) { n <- length(x); n*sum((x-mean(x))^4)/(sum((x-mean(x))^2)^2)-3 }
} else { library(e1071) }

# 2. 定义全能统计函数 (按您要求的顺序排列)
get_full_summary <- function(x) {
  # --- 基础指标 (Basic) ---
  valid_n <- sum(!is.na(x))
  min_val <- min(x, na.rm = TRUE)
  max_val <- max(x, na.rm = TRUE)
  m       <- mean(x, na.rm = TRUE)
  s       <- sd(x, na.rm = TRUE)
  
  # --- 进阶/鲁棒指标 (Advanced/Robust) ---
  med     <- median(x, na.rm = TRUE)
  q1      <- quantile(x, 0.25, na.rm = TRUE)
  q3      <- quantile(x, 0.75, na.rm = TRUE)
  cv      <- (s / m) * 100
  
  # --- 形状指标 (Shape) ---
  skew    <- skewness(x, na.rm = TRUE)
  kurt    <- kurtosis(x, na.rm = TRUE)
  norm_p  <- if(valid_n > 3 && valid_n < 5000) shapiro.test(x)$p.value else NA
  
  # --- 整理成一行，列名采用中英文混合 ---
  data.frame(
    # 1. 基础信息
    `样本量 (N)`           = valid_n,
    `最小值 (Min)`         = sprintf("%.2f", min_val),
    `最大值 (Max)`         = sprintf("%.2f", max_val),
    `均值 ± 标准差 (Mean ± SD)` = paste0(sprintf("%.2f", m), " ± ", sprintf("%.2f", s)),
    
    # 2. 鲁棒指标 (非正态推荐用这个)
    # 格式：中位数 (下四分位, 上四分位)
    `中位数 (Median) (Q1, Q3)` = paste0(sprintf("%.2f", med), " (", sprintf("%.2f", q1), ", ", sprintf("%.2f", q3), ")"),
    
    # 3. 变异与形状
    `变异系数 (CV %)`      = sprintf("%.2f", cv),
    `偏度 (Skewness)`      = sprintf("%.2f", skew),
    `峰度 (Kurtosis)`      = sprintf("%.2f", kurt),
    `正态性 P值 (Shapiro P)` = sprintf("%.3f", norm_p),
    
    check.names = FALSE
  )
}

# 3. 计算“整体 (Total)”
total_stats <- get_full_summary(analysis_data$Sourness_Score)
row.names(total_stats) <- "总体 (Total N=57)"

# 4. 计算“各分组 (By Group)”
group_stats <- analysis_data %>%
  group_by(Group) %>%
  summarise(Data = list(Sourness_Score), .groups = "drop") %>%
  rowwise() %>%
  mutate(Stats = list(get_full_summary(unlist(Data)))) %>%
  unnest(Stats) %>%
  select(-Data)

# 处理行名
group_stats_df <- as.data.frame(group_stats)
rownames(group_stats_df) <- group_stats_df$Group
group_stats_df <- group_stats_df %>% select(-Group)

# 5. 合并并输出
final_table1 <- rbind(total_stats, group_stats_df)
final_table1 <- final_table1 %>% tibble::rownames_to_column("分组 (Group)")

# 保存
write_csv(final_table1, "Table1_Descriptive_Statistics_Mixed.csv")

cat(">>> 描述性统计表 (Table 1) 已生成！\n")
cat(">>> 列顺序已调整：N -> Min/Max -> Mean -> Median(Robust) -> CV -> Skew/Kurt\n")

# 展示表格
knitr::kable(final_table1, caption = "表1：酸感得分描述性统计 (Table 1: Descriptive Statistics of Sourness Scores)")
```

## 3.2 化学指标变异系数图

```{r}
# ==========================================================
# 2.1 补充图表：化学指标变异系数 (CV) 分布图
# ==========================================================
library(ggplot2)
library(dplyr)
library(tidyr)

# 1. 准备数据
# 假设 analysis_data 已经加载
# 我们需要剔除 metadata (Sample_ID, Group, Sourness_Score 等)
# 只保留那 100 多个化学指标
# 这里假设前 4 列是基本信息，第 5 列开始是化学指标
# 【注意】请根据你的实际数据调整 select 的排除项
chem_data <- analysis_data %>%
  select(-Sample_ID, -Group, -Sourness_Score) %>%
  select(where(is.numeric)) # 确保只选数值列

# 2. 计算每个指标的 CV (变异系数)
cv_stats <- chem_data %>%
  summarise(across(everything(), list(
    Mean = ~mean(., na.rm = TRUE),
    SD = ~sd(., na.rm = TRUE)
  ))) %>%
  pivot_longer(cols = everything(), 
               names_to = c("Feature", "Stat"), 
               names_sep = "_") %>%
  pivot_wider(names_from = Stat, values_from = value) %>%
  mutate(
    CV = (SD / Mean) * 100
  ) %>%
  arrange(CV) %>% # 按 CV 从小到大排序
  mutate(
    Rank = row_number(), # 生成排名 1, 2, 3...
    Is_High_Var = ifelse(CV > 20, "High Variation (>20%)", "Low Variation") # 设定一个阈值分类
  )

# 3. 绘图 (S型排位散点图)
p_cv <- ggplot(cv_stats, aes(x = Rank, y = CV)) +
  # 画点，颜色根据 CV 大小渐变
  geom_point(aes(color = CV), size = 2.5, alpha = 0.8) +
  
  # 添加 20% 阈值线
  geom_hline(yintercept = 20, linetype = "dashed", color = "red", alpha = 0.6) +
  annotate("text", x = 5, y = 25, label = "Threshold: CV = 20%", color = "red", hjust = 0, size = 3.5) +
  
  # 颜色设置
  scale_color_gradient(low = "#4DBBD5", high = "#E64B35", name = "CV (%)") +
  
  # 标注几个 CV 的关键物质 (最大的2个和最小的2个)
  geom_text(data = rbind(head(cv_stats, 2), tail(cv_stats, 2)), 
            aes(label = Feature, 
                # 智能对齐：排名靠前(最小)的文字在右(-0.2)，排名靠后(最大)的文字在左(1.2)
                hjust = ifelse(Rank < nrow(cv_stats)/2, -0.2, 1.2)), 
            vjust = 0.5, size = 2.5, color = "black") +
  # 主题美化
  theme_bw() +
  labs(
    
    subtitle = paste0("Total ", nrow(cv_stats), " Indicators | Mean CV: ", round(mean(cv_stats$CV), 1), "%"),
    x = "化学指标",
    y = "变异系数 (%)"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "right"
  )

# 4. 保存
ggsave("Figure1_Chemical_CV_Distribution.svg", p_cv, width = 8, height = 5, dpi = 300)

print(p_cv)

# 5. 生成论文写作素材 (直接算出来填空)
cat(">>> 论文写作素材 (2.1节):\n")
cat(paste0("本研究共检测了 ", nrow(cv_stats), " 种化学成分。\n"))
cat(paste0("统计分析显示，化学成分的变异系数 (CV) 范围为 ", round(min(cv_stats$CV),1), "% 至 ", round(max(cv_stats$CV),1), "%。\n"))
cat(paste0("其中，", sum(cv_stats$CV > 20), " 个指标 (占比 ", round(sum(cv_stats$CV > 20)/nrow(cv_stats)*100, 1), "%) 的 CV 值大于 20%。\n"))
```

## 四、差异性分析

```{r}
# ==========================================================
# Phase 2: 差异性分析 (Kruskal-Wallis) - 中英文表头版
# ==========================================================
library(dplyr)
library(readr)
library(tidyr)

# 1. 检查数据
if (!exists("analysis_data") || !exists("name_mapping") || !exists("candidates")) {
  stop("数据缺失！请先选中并运行 Phase 1 的全部代码。")
}

cat(">>> 开始进行 Kruskal-Wallis 差异性筛选...\n")

# 2. 批量计算 (lapply 高效版)
target_vars <- candidates$Computational_Name 

kw_list <- lapply(target_vars, function(var) {
  test_data <- analysis_data %>% 
    select(Group, all_of(var)) %>% 
    na.omit()
  
  if (nrow(test_data) > 3 && n_distinct(test_data$Group) > 1) {
    kw_test <- kruskal.test(as.formula(paste(var, "~ Group")), data = test_data)
    return(data.frame(
      Computational_Name = var,
      P_Value = kw_test$p.value,
      Statistic = kw_test$statistic,
      stringsAsFactors = FALSE
    ))
  } else {
    return(data.frame(
      Computational_Name = var,
      P_Value = NA,
      Statistic = NA,
      stringsAsFactors = FALSE
    ))
  }
})

kw_results <- bind_rows(kw_list)

# 3. 结果整理与中文表头重命名
final_results <- kw_results %>%
  left_join(name_mapping, by = "Computational_Name") %>%
  filter(!is.na(P_Value)) %>%
  arrange(P_Value) %>%
  mutate(
    P_Adj = p.adjust(P_Value, method = "BH"),
    Significance = case_when(
      P_Value < 0.001 ~ "***",
      P_Value < 0.01  ~ "**",
      P_Value < 0.05  ~ "*",
      TRUE            ~ "ns"
    )
  ) %>%
  # --- 关键修改：重命名列名为中英文格式 ---
  select(
    `化学成分 (Chemical Component)` = Display_Name,
    `P值 (P-Value)` = P_Value,
    `校正P值 (Adj. P-Value)` = P_Adj,
    `显著性 (Significance)` = Significance,
    `统计量 (H-Statistic)` = Statistic,
    `变量代码 (Variable Code)` = Computational_Name
  )

# 4. 筛选显著物质 (P < 0.05)
# 注意：这里筛选用的是反引号括起来的新列名
candidates_significant <- final_results %>% 
  filter(`P值 (P-Value)` < 0.05)

# 5. 保存
write_csv(final_results, "2_Diff_Analysis_All_Results_Bilingual.csv")
write_csv(candidates_significant, "2_Diff_Analysis_Sig_Candidates_Bilingual.csv")

# 6. 打印预览
cat("------------------------------------------------\n")
cat("差异分析完成！结果已保存为 Bilingual 版本。\n")
cat("显著差异指标数量:", nrow(candidates_significant), "\n")
print(head(candidates_significant[, 1:4], 5)) # 打印前5行看看效果
```

## 五、相关性分析

```{r}
# ==========================================================
# Phase 3: 差异物质的相关性分析 (智能修复版)
# ==========================================================
library(dplyr)
library(ggplot2)
library(readr)
library(stringr)
library(svglite)

# 1. 环境检查
if (!exists("analysis_data")) stop("请先运行 Phase 1 加载数据！")

# 2. 读取 Phase 2 的“幸存者名单”
if (!file.exists("2_Diff_Analysis_Sig_Candidates_Bilingual.csv")) {
  stop("找不到 Phase 2 的结果文件，请先运行差异分析。")
}
diff_sig_data <- read_csv("2_Diff_Analysis_Sig_Candidates_Bilingual.csv", show_col_types = FALSE)

# --- 【关键修复】：智能匹配变量名列 ---
# 既然 Phase 2 把名字改长了，我们这里就去抓那个长名字
if ("Computational_Name" %in% colnames(diff_sig_data)) {
  # 情况A：如果是英文表头
  target_vars <- diff_sig_data$Computational_Name
  # 顺便获取中文名列表（如果有）
  target_names <- if("Display_Name" %in% colnames(diff_sig_data)) diff_sig_data$Display_Name else target_vars
  
} else if ("变量代码 (Variable Code)" %in% colnames(diff_sig_data)) {
  # 情况B：如果是中英文混合表头 (您现在的 Phase 2 就是这个)
  target_vars <- diff_sig_data$`变量代码 (Variable Code)`
  target_names <- diff_sig_data$`化学成分 (Chemical Component)`
  
} else {
  stop("错误：在CSV里找不到变量代码列！请检查 Phase 2 生成的列名。")
}

cat(">>> Phase 3 分析范围锁定：成功提取到", length(target_vars), "个差异显著物质。\n")

# ----------------------------------------------------------
# Part A: 全量计算 (生成大表)
# ----------------------------------------------------------
get_stars <- function(p) {
  if (is.na(p)) return("")
  if (p < 0.001) return("***")
  if (p < 0.01) return("**")
  if (p < 0.05) return("*")
  return("") 
}

cor_results <- data.frame()
valid_count <- 0

# 使用索引 i 同时获取 变量代码 和 中文名称
for (i in seq_along(target_vars)) {
  
  comp_name <- as.character(target_vars[i]) # 确保是字符串
  disp_name <- as.character(target_names[i]) # 对应的中文名
  
  # 核心判断：这个代码在原始数据里存在吗？
  if (comp_name %in% colnames(analysis_data)) {
    # 计算 Spearman 相关性
    res <- cor.test(analysis_data[[comp_name]], analysis_data$Sourness_Score, 
                    method = "spearman", exact = FALSE)
    
    cor_results <- rbind(cor_results, data.frame(
      Display_Name = disp_name,
      Computational_Name = comp_name,
      Rho = as.numeric(res$estimate), # 强制转数字
      P_Value = as.numeric(res$p.value),
      Stars = get_stars(res$p.value),
      Type = ifelse(res$estimate > 0, "Positive (Promoting)", "Negative (Suppressing)")
    ))
    valid_count <- valid_count + 1
  } else {
    cat("警告：原始数据中找不到变量 [", comp_name, "]，已跳过。\n")
  }
}

# --- 空表保护 ---
if (nrow(cor_results) == 0) {
  stop("错误：没有计算出任何结果！请检查 analysis_data 的列名是否和 Phase 2 的变量代码一致。")
}

# 按相关性绝对值排序
full_table <- cor_results %>% arrange(desc(abs(Rho)))

# 保存大表
write_csv(full_table, "3_Phase3_Correlation_All_Significant.csv")

cat(">>> Part A 完成！成功计算了", valid_count, "个物质的相关性。\n")
cat(">>> 结果已保存为 '3_Phase3_Correlation_All_Significant.csv'\n")


# ----------------------------------------------------------
# Phase 3 Part B: 棒棒糖图 (自动绘图)
# ----------------------------------------------------------
# 1. 直接使用上面计算好的 full_table，不需要重新读取
cat(">>> 开始绘制棒棒糖图...\n")

# 2. 专家精选名单 (根据您的数据，您可以手动调整这里)
# 为了防止报错，我们先看看 full_table 里前 15 个最显著的物质是谁，直接画它们
# 如果您有特定的专家名单，把下面这行注释掉，解开原来的 expert_selection
#top_15_vars <- full_table$Display_Name[1:min(15, nrow(full_table))] 

expert_selection <- top_15_vars 
# 如果要用之前的固定名单，请取消注释下面几行：
 expert_selection <- c("绿原酸", "芸香苷", "蔗糖", "葡萄糖", "总糖", "DDMP", 
                      "乙酸", "丙酸", "糠醛", "异戊酰胺", "草酸", "柠檬酸", 
                      "烟碱", "总氮", "3-甲基吲哚", "吡咯", "3-甲基戊酸")

# 3. 提取绘图数据 (加一个保护，防止名单里的名字表里没有)
plot_data <- full_table %>%
  filter(Display_Name %in% expert_selection) %>%
  arrange(desc(abs(Rho)))

if (nrow(plot_data) == 0) {
  cat("警告：绘图数据为空！可能是因为专家名单里的名字在数据里找不到。\n")
} else {
  # 4. 绘图
  font_family <- "SimSun" 
  
  p <- ggplot(plot_data, aes(x = reorder(Display_Name, Rho), y = Rho)) +
    geom_segment(aes(xend = reorder(Display_Name, Rho), y = 0, yend = Rho, color = Type), 
                 linewidth = 1.2) + 
    geom_point(aes(color = Type, size = abs(Rho)), alpha = 0.9) +
    geom_text(aes(label = Stars, y = Rho), 
              nudge_y = ifelse(plot_data$Rho > 0, 0.08, -0.08),
              vjust = 0.75, size = 6, fontface = "bold", family = font_family) +
    scale_color_manual(values = c("Positive (Promoting)" = "#E41A1C", 
                                  "Negative (Suppressing)" = "#377EB8"),
                       labels = c("负向关联", "正向关联 ")) +
    coord_flip() +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray60", linewidth = 0.8) +
    labs(
         x = "", 
         y = "Spearman 相关系数 (Rho)",
         color = "关联类型", 
         size = "关联强度") +
    theme_bw(base_size = 14) + 
    theme(
      text = element_text(family = font_family), 
      plot.title = element_text(face = "bold", size = 18, hjust = 0.5, family = font_family),
      legend.position = "bottom"
    )
  
  # 5. 保存
  ggsave("3_Expert_Correlation_Lollipop_Final.svg", p, 
         width = 8, height = 7, dpi = 300, 
         device = svglite::svglite, 
         fix_text_size = FALSE)
  
  cat(">>> 图片已生成：3_Expert_Correlation_Lollipop_Final.svg\n")
}
```

你在看这张图的时候，可能会发现一个**非常有趣且反常识**的现象，这正是你论文的亮点：

1.  **糖类（总糖、蔗糖、葡萄糖）是正相关（Rho \> 0）**：

    -   *常规认知*：糖通常掩盖酸味（负相关）。

    -   *你的数据*：糖越高，酸感越强。

    -   *解释方向*：这可能说明在你的加热卷烟体系中，**“糖酸共存”**。可能是糖在加热过程中降解产生了酸（如甲酸、乙酸、乙酰丙酸等），或者高糖样品本身就是高等级烟叶，其内含物（包括酸）整体都丰富。这是一个非常好的 Discussion 切入点。

2.  **乙酸 vs. 柠檬酸**：

    -   **乙酸（正相关）**：直接提供刺激性酸感。

    -   **柠檬酸/草酸（负相关）**：作为非挥发性有机酸，它们可能更多起到缓冲 pH 值的效果，使烟气柔和，反而降低了那种“尖刺”的酸感评分。123

## 六、聚类分析

```{r}
# ==========================================================
# Phase 4: 聚类热图 (无ID极简·最终修订版)
# ==========================================================
library(pheatmap)
library(dplyr)
library(readr)
library(RColorBrewer)
library(svglite)
library(ggplotify)
library(ggplot2)

# 1. 环境与数据检查
if (!exists("analysis_data")) stop("数据未加载，请先运行 Phase 1")

# --- 读取样品信息 ---
if (!file.exists("sample_info.csv")) stop("找不到 sample_info.csv")
sample_info <- read_csv("sample_info.csv", show_col_types = FALSE) %>%
  mutate(
    Sourness_Class = case_when(
      Sourness_Score == 0 ~ "无酸",
      Sourness_Score > 0 & Sourness_Score <= 1.5 ~ "微酸",
      Sourness_Score > 1.5 & Sourness_Score <= 3.0 ~ "稍酸",
      Sourness_Score > 3.0 & Sourness_Score <= 4.5 ~ "酸",
      Sourness_Score > 4.5 ~ "强酸"
    )
  )

# --- 读取双语映射表 ---
map_file <- "2_Diff_Analysis_Sig_Candidates_Bilingual.csv"
if (!file.exists(map_file)) stop(paste("找不到文件:", map_file))
raw_map <- read_csv(map_file, show_col_types = FALSE)

# 智能提取映射关系
if ("变量代码 (Variable Code)" %in% colnames(raw_map)) {
  name_map <- raw_map %>%
    select(
      Computational_Name = `变量代码 (Variable Code)`,
      Display_Name = `化学成分 (Chemical Component)`
    )
} else {
  name_map <- raw_map %>% select(Computational_Name, Display_Name)
}

# --- 读取相关性结果 (筛选 P < 0.05) ---
cor_file <- "3_Phase3_Correlation_All_Significant.csv"
if (!file.exists(cor_file)) stop(paste("找不到文件:", cor_file))
cor_table <- read_csv(cor_file, show_col_types = FALSE)
sig_vars <- cor_table %>% filter(P_Value < 0.05) %>% pull(Computational_Name)

# 2. 准备矩阵
# 确保只选出数据中存在的列
valid_vars <- intersect(sig_vars, colnames(analysis_data))

# 【修改点 1】：不再选 Sample_ID，直接选物质列
heatmap_matrix <- analysis_data %>% 
  select(all_of(valid_vars)) %>% 
  as.data.frame()

# 【修改点 2】：不再设置具体行名，使用默认顺序
# (pheatmap 会自动处理，不需要我们人为指定 ID)

# --- 中文名替换 ---
current_names <- colnames(heatmap_matrix)
new_names <- name_map$Display_Name[match(current_names, name_map$Computational_Name)]
colnames(heatmap_matrix) <- ifelse(is.na(new_names), current_names, new_names)

# --- 特殊改名: 二氢猕猴桃内酯-烟气 ---
target_old_name <- "二氢猕猴桃内酯2"
target_new_name <- "二氢猕猴桃内酯-烟气"
if (target_old_name %in% colnames(heatmap_matrix)) {
  colnames(heatmap_matrix)[colnames(heatmap_matrix) == target_old_name] <- target_new_name
}

# Z-Score 标准化
heatmap_matrix_scaled <- scale(heatmap_matrix)

# 3. 准备注释
# 【修改点 3】：不再选 Sample_ID，只选绘图需要的两列
ann_col_df <- sample_info %>%
  select(Sourness_Class, Tobacco_Type) %>%
  rename(`酸感等级` = Sourness_Class, `原料类型` = Tobacco_Type) %>%
  as.data.frame()

# 【关键】：确保注释行数和矩阵行数一致 (防止数据行数不匹配报错)
if (nrow(ann_col_df) != nrow(heatmap_matrix_scaled)) {
  # 如果行数不对，尝试截取 (通常不会发生，除非数据源不对)
  min_rows <- min(nrow(ann_col_df), nrow(heatmap_matrix_scaled))
  ann_col_df <- ann_col_df[1:min_rows, , drop=FALSE]
  heatmap_matrix_scaled <- heatmap_matrix_scaled[1:min_rows, ]
}
# 强行赋予临时行名以实现对齐 (这是 pheatmap 内部逻辑需要的，用户看不见)
rownames(heatmap_matrix_scaled) <- paste0("S", 1:nrow(heatmap_matrix_scaled))
rownames(ann_col_df) <- paste0("S", 1:nrow(ann_col_df))

# 4. 颜色定义
ann_colors <- list(
  `酸感等级` = c("无酸"="#2C7BB6", "微酸"="#ABDDA4", "稍酸"="#FDAE61", "酸"="#D7191C", "强酸"="#800026"),
  `原料类型` = c("烤烟"="#33A02C", "晒黄烟"="#FFD700", "晒红烟"="#E31A1C", "雪茄烟"="#B15928", "香料烟"="#FF7F00", "白肋烟"="#1F78B4")
)

# 5. 绘图
ph <- pheatmap(t(heatmap_matrix_scaled), 
         annotation_col = ann_col_df, 
         annotation_colors = ann_colors,
         clustering_distance_rows = "correlation", 
         clustering_distance_cols = "euclidean",    
         clustering_method = "complete",
         color = colorRampPalette(c("navy", "white", "firebrick3"))(100),
         
         # 视觉设置
         show_colnames = FALSE, # 不显示样品名 (用户本来也不想看 ID)
         show_rownames = TRUE,  # 显示中文物质名
         fontsize_row = 8,
         border_color = NA,
         silent = TRUE
)

# 保存
p_gg <- as.ggplot(ph)
ggsave("4_Cluster_Heatmap_Final_CN.svg", p_gg, width = 10, height = 12, device = svglite::svglite, fix_text_size = FALSE)

cat(">>> 绘图完成！图片文件：4_Cluster_Heatmap_Final_CN.svg\n")
```

```{r}
# ----------------------------------------------------------
# 补充步骤：同时保存为高清 PNG 格式 (方便预览和插入PPT)
# ----------------------------------------------------------

# 使用 ggsave 保存为 png
ggsave("4_Cluster_Heatmap_Final_CN.png", p_gg, 
       width = 10, height = 12, 
       dpi = 300,             # 设置为 300 dpi (高清标准)
       bg = "white")          # 确保背景是白色的，防止透明

print(">>> PNG宽图片也已生成：4_Cluster_Heatmap_Final_CN.png")
```

```{r}
# ==========================================================
# 辅助分析：聚类分支统计 (修正列名版)
# ==========================================================
# 1. 提取聚类结果 (切成 2 刀)
sample_clusters <- cutree(ph$tree_col, k = 2)

cat("\n====== 聚类分支详细解剖 ======\n")

# --- 分支 1 (Cluster I) ---
group1_samples <- names(sample_clusters[sample_clusters == 1])
cat(">>> 分支 1 (30个样品) 的成分构成：\n")
# 这里用 Tobacco_Type，因为 sample_info 原始表里是英文列名
print(table(sample_info$Tobacco_Type[sample_info$Sample_ID %in% group1_samples]))
cat("   [推测]：这应该是红色/绿色集中的‘致酸/烤烟簇’。\n\n")

# --- 分支 2 (Cluster II) ---
group2_samples <- names(sample_clusters[sample_clusters == 2])
cat(">>> 分支 2 (27个样品) 的成分构成：\n")
print(table(sample_info$Tobacco_Type[sample_info$Sample_ID %in% group2_samples]))
cat("   [推测]：这应该是蓝色/杂色集中的‘低酸/晾晒烟簇’。\n")

cat("\n==============================\n")
```

# 4. 结论部分文字撰写

### **4 结论**

**(1) 原料类型是决定加热卷烟酸感风格的首要因素，不同类型烟叶的感官特征差异显著。** 烤烟及晒黄烟的酸感评分显著较高，主要分布于“酸”及“稍酸”区间，是加热卷烟酸感风格的主要载体；白肋烟、晒红烟及雪茄烟酸感普遍微弱，主要表现为“微酸”或“无酸”，不具备典型的酸感特征。

**(2) 绿原酸、芸香苷、还原糖、蔗糖及乙酸是决定酸感强度的核心正向贡献指标。** 上述物质与酸感评分呈极显著正相关，并在**烤烟型原料**中呈高丰度富集。这种“高糖-高多酚”的化学背景直接构成了加热卷烟强酸感风格的物质基础。

**(3) 烟碱、总氮、异戊酰胺及草酸是限制酸感表达的关键负向抑制指标。** 此类含氮化合物及非挥发性酸与酸感评分呈显著负相关，主要富集于**白肋烟及晒红烟**中。其高含量存在产生的化学中和与感官掩蔽效应，是导致此类原料酸感缺失的主要原因。

**4) 填补了加热卷烟酸感评价方法的空白，明确了原料筛选方向。** 本研究首次构建了针对加热卷烟的酸感量化评价标准，揭示了“原料-化学-感官”的内在关联规律。该研究结果为加热卷烟专用原料的定向筛选、配方重组及感官风格的精准调控提供了科学依据。

# 0. 引言

酸感（Sourness Perception）是食品与烟草感官品质的重要维度。在感官评价学中，酸感通常被定义为由氢离子刺激味蕾产生的基础味觉（Taste）与挥发性有机酸刺激嗅觉受体产生的酸香（Aroma）所构成的**味觉-嗅觉跨模态综合感知**（参考：Spence C 等，《Multisensory Flavor Perception》或类似感官科学综述）。其强度与特性不仅取决于酸性物质的总量，更依赖于特定呈酸组分（如乙酸、乳酸、苹果酸等）的比例平衡及与其他风味物质的协同作用。

**酸感（Sourness Perception）是食品与烟草感官品质的重要维度。在现代感官科学（Sensory Science）视野下，酸感不再局限于单一的味觉维度，而是被定义为由氢离子刺激味蕾产生的基础味觉（Taste）与挥发性有机酸刺激嗅觉受体产生的酸香（Aroma）所构成的味觉-嗅觉跨模态综合感知（Multisensory Flavor Perception）** **\[1-2\]**。其强度与特性不仅取决于酸性物质的总量，更依赖于特定呈酸组分（如乙酸、乳酸等）的比例平衡及与其他风味物质的协同作用。

**\[1\] 对应文献 A (Cell 综述):**
Spence C. Multisensory flavor perception\[J\]. **Cell**, 2015, 161(1): 24-35.

**\[2\] 对应文献 B (有机酸研究):**
Zampini M, Wantling E, Phillips N, et al. Multisensory flavor perception: Assessing the influence of fruit acids and color cues on the perception of fruit-flavored beverages\[J\]. **Food Quality and Preference**, 2008, 19(3): 335-343.

在食品科学领域，关于酸感形成的物质基础研究已较为成熟。\*\*徐伟等（《发酵时间对俄式面包面团有机酸形成及其酸感的影响》）\*\*在俄式面包发酵研究中指出，乳酸与乙酸的特定比例（约 5.5:1）是形成柔和酸感的关键，单一酸含量的过高或过低均会导致感官失衡；\*\*刘春凤等（《小麦麦芽制麦过程中酸感物质的变化》）\*\*发现小麦麦芽制麦过程中，乙酸、乳酸、柠檬酸等有机酸的动态积累直接决定了最终产品的酸感强度；\*\*马艺荧等（《东北酸菜不同发酵时间有机酸变化及其对产品酸感的影响》）\*\*则进一步证实，东北酸菜发酵中乳酸与其他有机酸构建的缓冲体系是赋予产品“酸而不尖”特征的核心机制。这些研究表明，有机酸的种类丰度、浓度阈值及组分间的协同拮抗效应是调控感官酸感的决定性因素。

然而，在烟草科学领域，尤其是针对传统卷烟的研究中，“酸感”往往未被作为独立的感官指标进行评价，更多是被归纳为“酸香”韵调（属于香气范畴）或某种特定的刺激性（属于口感范畴）（参考：**史清照等，《卷烟烟气内源性酸香成分的加香贡献度》**；**王颖等，《烟草中香气成分分析研究综述》**）。\*\*范武等（《卷烟主流烟气酸香特征成分组群的分布特征及感官贡献》）\*\*虽系统筛选了卷烟主流烟气中的酸香特征成分，但其侧重点在于香气贡献而非味觉感知。

随着新型烟草制品的兴起，这一感官维度的重要性日益凸显。加热卷烟由于其独特的低温加热原理（\<350℃），避免了传统燃吸状态下（\>800℃）有机酸的剧烈热解与氧化损耗（参考：**相关加热卷烟温度/热解文献**），使得原料中原本易挥发的乙酸、丙酸等小分子酸及部分热解产物能够高效率地转移至气溶胶中。这导致加热卷烟在感官体验上呈现出显著区别于传统卷烟的、更为直接且强烈的\*\*“酸感”\*\*特征。

前期评吸实验发现，加热卷烟的酸感表现出极强的原料特异性：烤烟及香料烟型加热卷烟常伴有明显的酸味与生津感，而晒红烟、白肋烟等原料制成的产品则酸感匮乏。这种显著的感官分化暗示了原料基质中的某种化学模式正在深刻影响着加热卷烟的酸感表达。然而，目前关于加热卷烟酸感形成的物质基础尚不明确，核心致酸组分及其与原料特性的关联机制仍是未解之谜。

鉴于酸感对加热卷烟感官质量的重要影响，以及现有研究的局限性，深入探究加热卷烟中酸感物质的组成及原料特性具有重要意义。本研究主要考察不同类型加热卷烟的酸感差异性以及影响酸感的主要指标，旨在揭示加热卷烟酸感的物质基础，为优化产品感官品质提供理论依据。

# 摘要与关键词

### **摘要**

**【背景和目的】**
酸感（Sourness）是加热卷烟区别于传统燃吸卷烟的特征性感官属性，其形成受低温热解环境与原料特性的双重影响，但目前关于其确切的化学物质基础及“原料-化学-感官”的关联机制尚不明确。本研究旨在通过构建酸感量化评价体系，系统探究不同类型烟叶原料的酸感差异，并溯源决定该感官风格的关键化学组分。

**【方法】**
本研究选取57份具有代表性的不同类型（烤烟、白肋烟、香料烟、晒红烟、晒黄烟等）加热卷烟原料，首先建立0\~5分制的酸感定量评价标准进行感官表征。随后，检测样品中98种常规化学成分及致香组分。采用描述性统计分析评估感官数据的离散特征；利用非参数Kruskal-Wallis H检验对不同酸感组别的化学成分进行差异性筛选；结合Benjamini-Hochberg校正（FDR）与斯皮尔曼（Spearman）秩相关系数，判定核心差异物质的贡献方向与强度；最后，通过双向层次聚类分析（HCA）验证关键化学指标对原料类型及感官风格的区分效能。

**【结果】**
研究发现，加热卷烟的酸感表现出极强的原料依赖性，变异系数高达103.54%，其中烤烟及晒黄烟呈现显著的“高酸”特征，而白肋烟及晒红烟呈现“低酸/无酸”特征。通过差异分析与相关性筛选，共锁定49种关键化学标志物。其中，**正向贡献指标**主要包括绿原酸、芸香苷等多酚类，葡萄糖、蔗糖等糖类，以及乙酸、DDMP等热解产物，其在烤烟型原料中高丰度富集，反映了“高糖/高多酚”代谢背景下的热解产酸潜力；**负向抑制指标**主要包括烟碱、总氮、异戊酰胺及草酸等，其在白肋烟等原料中富集，揭示了生物碱对有机酸的化学中和效应及感官掩蔽机制。聚类热图清晰地将样品划分为“高糖产酸型”与“高碱抑酸型”两大类群，与感官评价结果高度一致。

**【结论】**
本研究证实了原料的碳氮代谢差异是决定加热卷烟酸感风格的先天基础，明确了“糖类热解产酸”与“生物碱中和抑酸”是调控酸感表达的双重核心机制。研究构建的基于糖碱比、特征多酚及关键有机酸的化学指纹图谱，填补了加热卷烟酸感评价的空白，为专用原料的定向筛选、配方设计及感官品质调控提供了科学依据和量化指标。

### **关键词：**加热卷烟；酸感；物质基础；原料差异；Kruskal-Wallis检验；聚类分析
